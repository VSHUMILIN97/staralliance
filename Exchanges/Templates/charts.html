{% extends 'base.html' %}

{% block content %}
<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="https://code.highcharts.com/stock/highstock.js"></script>
<script src="https://code.highcharts.com/stock/modules/drag-panes.js"></script>
<script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/css/bootstrap-select.min.css">
<!-- Latest compiled and minified JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/js/bootstrap-select.min.js"></script>
<!-- (Optional) Latest compiled and minified JavaScript translation files -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/js/i18n/defaults-*.min.js"></script>

<table>
    <tr>
        <td class="headerText"><p class="textWrapper">Сменить биржу и пару: &nbsp;</p></td>
        <td class="exchDropdown">
            <select class="selectpicker show-tick" id="exchSelector" data-live-search="true" data-size="3" title="Биржа" data-width="165px">
            </select>
        </td>
        <td>&nbsp;</td>
        <td class="pairDropdown">
            <select class="selectpicker show-tick" id="pairSelector" data-live-search="true" data-size="3" title="Пара" data-width="165px" disabled>
            </select>
        </td>
        <td>&nbsp;</td>
        <td class="btnHolder">
            <button type="button" class="btn btn-default btn-outline" id="okBtn"><span style="font-size: 14px;">Показать</span></button>
        </td>
        <td>&nbsp;</td>
        <td class="nothing">Сочетание не выбрано</td>
    </tr>
</table>

<div id="OHLCContainer" style="height: 600px; min-width: 310px"></div>
<div id="tickContainer" style="min-width: 310px; height: 400px; margin: 0 auto"></div>

    <script>
     var ws = new WebSocket("ws://127.0.0.1:8070/");
     ws.onopen = function (event) {
         ws.send(location.pathname);
     };
    var json_msg;
    var ticks = [];
     ws.onmessage = function (event) {
         alert(event.data);
         var art = JSON.parse(event.data);
         var json_msg = JSON.parse(art['tick']);
         for (var item in json_msg){
        ticks.push([
            new Date(json_msg[item]['TimeStamp']).getTime(),
            json_msg[item]['Tick']
        ]);
    }
    saver(ticks)
     };
function saver (obj){
    ticks = obj;
}
$.getJSON('https://jsonplaceholder.typicode.com/posts', function (data) {
//я В ДУШЕ не знаю ПОЧЕМУ он не работает без обращения за jsonом здесь, НО РАБОТАЕТ на фидле
//(нет, я знаю, как заставить его работать и без обращения, но тогда падает цветовая схема)
//возможно, когда-нибудь у нас будет своя страница, с которой можно будет взять json для графиков,
//поэтому давайте дружно сделаем вид, что эта ссылка - временная и стоит здесь как укор совести для того, чтобы не забыть об этом
//upd. теоретически, можно таскать данные и напрямую с бирж, если по пути избавиться от всего лишнего что они предоставляют
//и выделить только нужное (у меня на это не хватает мозгов)
        var ohlc = [],
        volBuy = [],
        volSell = [],

        groupingUnits = [[
            'hour',
            [1,3,6,12]
        ], [
            'day',
            [1,3,5,10]
        ], [
            'week',
            [1,2]
        ], [
            'month',
            [1, 2, 3, 4, 6]
        ]],

        i = 0;

    {% for item in testingOHLC %}
        ohlc.push([
            new Date('{{ item.TimeStamp|date:"d F Y T"}} {{ item.TimeStamp|time:"H:i"}}').getTime(),
            {{ item.PrevDay|floatformat:8 }},
            {{ item.High|floatformat:8 }},
            {{ item.Low|floatformat:8 }},
            {{ item.Last|floatformat:8 }}
        ]);
    {% endfor %}

    {% for item in testingMHistBuy %}
        volBuy.push([
            new Date('{{ item.TimeStamp|date:"d F Y T"}} {{ item.TimeStamp|time:"H:i"}}').getTime(),
            {{ item.Price|floatformat:8 }}
        ]);
    {% endfor %}
    {% for item in testingMHistSell %}
        volSell.push([
            new Date('{{ item.TimeStamp|date:"d F Y T"}} {{ item.TimeStamp|time:"H:i"}}').getTime(),
            {{ item.Price|floatformat:8 }}
        ]);
    {% endfor %}


    Highcharts.stockChart('OHLCContainer', {
    		rangeSelector: {
            selected: 1,
            buttons: [{
            type: 'hour',
            count: 1,
            text: '1h'
            }, {
            type: 'day',
            count: 1,
            text: '1d'
            }, {
            type: 'week',
            count: 1,
            text: '1w'
            }, {
            type: 'month',
            count: 1,
            text: '1m'
            }, {
            type: 'month',
            count: 6,
            text: '6m'
            }, {
            type: 'year',
            count: 1,
            text: '1y'
            }, {
            type: 'all',
            text: 'All'
            }]
        },

        chart: {
            zoomType: 'x',
            events: {
    			load: function () {
      			this.pointCount = 1;
      		    },
    			redraw: function () {
      			this.pointCount = 1;
      		    }
    		},
        selectionMarkerFill: 'rgba(230, 220, 204, .3)'
        },

        title: {
            text: 'График свечек и объемов для {{ pair }} ({{ exchange }})'
        },

        yAxis: [{
            labels: {
                align: 'right',
                x: -3
            },
            title: {
                text: 'Свечки'
            },
            height: '60%',
            lineWidth: 2,
            resize: {
                enabled: true
            }
        }, {
            labels: {
                align: 'right',
                x: -3
            },
            title: {
                text: 'Объемы'
            },
            top: '65%',
            height: '35%',
            offset: 0,
            lineWidth: 2
        }],
		plotOptions: {
            column: {
                grouping: false,
                shadow: false,
                borderWidth: 0.5,
            }
    	},
        tooltip: {
            shared: true,
            useHTML: true,
            headerFormat: '<span>{point.key}</span>'
        },

        series: [{
            type: 'candlestick',
            name: '{{ pair }} OHLC',
            data: ohlc,
            dataGrouping: {
                units: groupingUnits
            },
            tooltip: {
                valueDecimals: 8
            },
        }, {
            type: 'column',
            name: 'Покупка',
            data: volBuy,
            yAxis: 1,
            color: 'rgba(113, 218, 113, .7)',
            dataGrouping: {
                units: groupingUnits
            },
            tooltip: {
                valueDecimals: 8
            },
        },
        {
            type: 'column',
            name: 'Продажа',
            data: volSell,
            yAxis: 1,
            color: 'rgba(245, 112, 112, .9)',
            pointPadding: 0.3,
            dataGrouping: {
                units: groupingUnits
            },
            tooltip: {
                valueDecimals: 8
            },
        }]
    });
});

    $.getJSON('https://www.highcharts.com/samples/data/jsonp.php?filename=usdeur.json&callback=?', function (data) {





    Highcharts.stockChart('tickContainer', {
    		rangeSelector: {
            selected: 1,
            buttons: [{
            type: 'hour',
            count: 1,
            text: '1h'
            }, {
            type: 'day',
            count: 1,
            text: '1d'
            }, {
            type: 'week',
            count: 1,
            text: '1w'
            }, {
            type: 'month',
            count: 1,
            text: '1m'
            }, {
            type: 'month',
            count: 6,
            text: '6m'
            }, {
            type: 'year',
            count: 1,
            text: '1y'
            }, {
            type: 'all',
            text: 'All'
            }]
        },

        chart: {
            zoomType: 'x',
            events: {
    			load: function () {
      			this.pointCount = 1;
      		    },
    			redraw: function () {
      			this.pointCount = 1;
      		    }
    		},
        selectionMarkerFill: 'rgba(230, 220, 204, .3)'
        },

        title: {
            text: 'График тика {{ pair }} ({{ exchange }})'
        },

        plotOptions: {
            series: {
                states: {
                    hover: {
                        halo: {
                            size: 6,
                            attributes: {
                                fill: 'rgb(54, 54, 54)'
                            }
                        },
                        lineWidth: 1
                    }
                },
                marker: {
                    fillColor: 'rgb(54, 54, 54)'
                },
            },
        },

        series: [{
            name: '{{ pair }}',
            data: ticks,
            type: 'spline',
            tooltip: {
                valueDecimals: 8,
                useHTML: true,
                headerFormat: '<span>{point.key}</span>'
            },
            lineColor: 'rgb(54,54,54)'
        }]
    });
});

</script>

<script>
Highcharts.theme = {
   colors: ['#f35858', '#8085e9', '#8d4654', '#7798BF', '#aaeeee',
      '#ff0066', '#eeaaee', '#55BF3B', '#DF5353', '#7798BF', '#aaeeee'],
   chart: {
      backgroundColor: null,
      style: {
         fontFamily: 'Century Gothic, sans-serif'
      }
   },
   title: {
      style: {
         color: 'black',
         fontSize: '18px',
         fontWeight: 'bold'
      }
   },
   subtitle: {
      style: {
         color: 'black'
      }
   },
   tooltip: {
      borderWidth: 0.5,
      borderColor: '#3a3a3a'
   },

   plotOptions: {
      candlestick: {
      	upColor: '#33cc33',
        lineColor: '#3a3a3a',
        lineWidth: 0.5,
        animation: {
            duration: 500
        }
      },
      column: {
      	 borderColor: '#4a4a4a',
         animation: {
            duration: 500
         }
      },
      spline: {
         animation: {
            duration: 500
         }
      },
   },

   legend: {
      itemStyle: {
         fontWeight: 'bold',
         fontSize: '13px'
      }
   },
   xAxis: {
      labels: {
         style: {
            color: '#6e6e70'
         }
      },
      minRange: 3600 * 1000
   },
   yAxis: {
      labels: {
         style: {
            color: '#6e6e70'
         }
      }
   },

   // Highstock specific
   navigator: {
      xAxis: {
         gridLineColor: '#D0D0D8'
      },
      series: {
         color: '#aaaaaa',
         lineWidth: 1
      },
      maskFill: 'rgba(230, 220, 204, .5)'
   },
   rangeSelector: {
      buttonTheme: {
         fill: 'white',
         stroke: '#C0C0C8',
         'stroke-width': 1,
         states: {
            select: {
               fill: '#D0D0D8'
            }
         }
      }
   },
   scrollbar: {
      trackBorderColor: '#C0C0C8'
   },

   // General
   background2: '#E0E0E8'

};

Highcharts.setOptions(Highcharts.theme);
</script>

<style>
.headerText {
  font-family: "Roboto", Sans-Serif;
  font-size: 14px;
  color: rgb(54, 54, 54);
  display: inline-block;
  padding-left: 200px;
}

.pairDropdown {
    position: relative;
    display: inline-block;
    font-family: "Roboto", Sans-Serif;
}

.exchDropdown {
    position: relative;
    display: inline-block;
    font-family: "Roboto", Sans-Serif;
}

.btnHolder {
    color: rgb(54, 54, 54);
    font-family: "Roboto", Sans-Serif;
    display: inline-block;
}

.btn-default:focus {
    outline: none !important;
}

.btn-default:active {
    outline: none !important;
}

.selectpicker:focus {
    outline: none !important;
}

.selectpicker:active {
    outline: none !important;
}

.smallEmptySpace {
    margin-top: 10px;
}

.mediumEmptySpace {
    margin-top: 0px;
}

.bigEmptySpace {
    margin-top: 543px;
}

.nothing {
  margin-top: 5px;
  color: transparent;
}

.textWrapper {
  margin-top: 10px;
}
</style>

<script>
var exchs = document.getElementById("exchSelector");
{% for item in exchList %}
  var opt = document.createElement("option");
  opt.innerText = '{{ item }}';
  opt.style.textAlign = "left";
  exchs.appendChild(opt);
{% endfor %}

var update_pairs = function () {
    var success = false;
    $('#pairSelector').empty();
    $('.nothing').css('color', 'transparent');
    var pairs = document.getElementById("pairSelector");
    {% for item in combinations %}
        if ('{{ item.Exch }}' == $('#exchSelector').val()) {
          var opt = document.createElement("option");
          opt.innerText = '{{ item.Pair }}';
          opt.style.textAlign = "left";
          pairs.appendChild(opt);
          success = true;
        }
    {% endfor %}
    if (success == false) {
      $('.nothing').css('color', 'rgb(54, 54, 54)');
      $('.nothing').text('Похоже, для этой биржи ничего нет');
      $('#pairSelector').prop('disabled', true);
    }
    else {
      $('#pairSelector').prop('disabled', false);
    }
    $('#pairSelector').selectpicker('refresh');
};

$("#exchSelector").change(update_pairs);
$("#pairSelector").change( function () { $('.nothing').css('color', 'transparent'); } );


$('#okBtn').click( function() {
    if ($('#exchSelector').val().length && $('#pairSelector').val().length) {
        $('.nothing').css('color', 'transparent');
        var redirect = $(location).attr('href').replace('{{ exchange }}/','').replace('{{ pair }}/','');
        window.location.href = redirect+$('#exchSelector').val()+'/'+$('#pairSelector').val();
        ws.send($('#exchSelector').val()+' '+$('#pairSelector').val())
    }
    else
    {
        $('.nothing').text('Сочетание не выбрано');
        $('.nothing').css('color', 'rgb(54, 54, 54)');
    }
});

</script>
{% endblock content %}